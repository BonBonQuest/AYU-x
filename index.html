<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management System</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark body {
            background-color: #020617;
            color: #f1f5f9;
        }

        .mainBG {
            background-color: #f2f2f2;
        }

        .dark .mainBG {
            background-color: #0f172a;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="antialiased min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // --- Icon Wrapper & Definitions ---
        // Fix for Lucide icons in standalone React
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            const iconData = lucide.icons[iconName];

            if (!iconData) return null;

            // Handle Lucide's array structure for icon definitions
            // usually: [ ['path', {d:...}], ... ]
            if (Array.isArray(iconData)) {
                const svgContent = iconData.map(([tag, attrs]) => {
                    const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                    // Self-closing tags in SVG string or strict open/close
                    return `<${tag} ${attrStr}></${tag}>`;
                }).join('');

                return (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width={size}
                        height={size}
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className={className}
                        dangerouslySetInnerHTML={{ __html: svgContent }}
                        style={{ display: 'inline-block', verticalAlign: 'middle' }}
                    />
                );
            }

            return null;
        };

        const LayoutDashboard = (props) => <Icon name="LayoutDashboard" {...props} />;
        const Users = (props) => <Icon name="Users" {...props} />;
        const Briefcase = (props) => <Icon name="Briefcase" {...props} />;
        const Plus = (props) => <Icon name="Plus" {...props} />;
        const Trash2 = (props) => <Icon name="Trash2" {...props} />;
        const Edit = (props) => <Icon name="Edit" {...props} />;
        const Search = (props) => <Icon name="Search" {...props} />;
        const Moon = (props) => <Icon name="Moon" {...props} />;
        const Sun = (props) => <Icon name="Sun" {...props} />;
        const CheckCircle = (props) => <Icon name="CheckCircle" {...props} />;
        const XCircle = (props) => <Icon name="XCircle" {...props} />;
        const Calendar = (props) => <Icon name="Calendar" {...props} />;
        const MapPin = (props) => <Icon name="MapPin" {...props} />;
        const Clock = (props) => <Icon name="Clock" {...props} />;
        const Activity = (props) => <Icon name="Activity" {...props} />;
        const Menu = (props) => <Icon name="Menu" {...props} />;
        const X = (props) => <Icon name="X" {...props} />;
        const Home = (props) => <Icon name="Home" {...props} />;


        // --- UI Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`glass-panel rounded-2xl shadow-sm p-6 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", type = "button" }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-medium transition-all duration-200 flex items-center gap-2 active:scale-95";
            const variants = {
                primary: "bg-brand-600 text-white hover:bg-brand-500 shadow-lg shadow-brand-500/30",
                secondary: "bg-white dark:bg-dark-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50",
                danger: "bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30",
                ghost: "text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 hover:bg-slate-100 dark:hover:bg-slate-800"
            };
            return (
                <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, name, value, onChange, placeholder, type = "text", required = false }) => (
            <div className="flex flex-col gap-1.5">
                {label && <label className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</label>}
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    required={required}
                    placeholder={placeholder}
                    className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                />
            </div>
        );

        const Select = ({ label, name, value, onChange, options, required = false }) => (
            <div className="flex flex-col gap-1.5">
                {label && <label className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</label>}
                <select
                    name={name}
                    value={value}
                    onChange={onChange}
                    required={required}
                    className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                >
                    <option value="" disabled>Select {label}</option>
                    {options.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                </select>
            </div>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
                green: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300",
                purple: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300",
                amber: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            );
        };

        // --- Stats Card Component ---
        const StatCard = ({ title, value, icon, trend, subLabel }) => (
            <Card className="relative overflow-hidden group hover:border-brand-500/30 transition-all">
                <div className="flex justify-between items-start z-10 relative">
                    <div>
                        <p className="text-slate-500 dark:text-slate-400 font-medium mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-slate-800 dark:text-white mb-1">{value}</h3>
                        {subLabel && <p className="text-sm text-slate-400 dark:text-slate-500">{subLabel}</p>}
                    </div>
                    <div className="p-3 bg-brand-50 dark:bg-brand-900/20 text-brand-600 rounded-xl group-hover:scale-110 transition-transform">
                        {icon}
                    </div>
                </div>
                {/* Decorative background blob */}
                <div className="absolute -bottom-4 -right-4 w-24 h-24 bg-brand-500/5 rounded-full blur-2xl group-hover:bg-brand-500/10 transition-colors"></div>
            </Card>
        );


        // --- Views ---

        // 1. Dashboard
        const Dashboard = ({ customers, staff }) => {
            const totalCustomers = customers.length;
            const activeCustomers = customers.filter(c => c.status !== 'Inactive').length; // Assuming logical status or just all

            const totalStaff = staff.length;
            const totalShiftD = customers.filter(c => c.shift === 'D').length;

            // Calculate some simple stats
            const avgAge = customers.length > 0
                ? Math.round(customers.reduce((acc, curr) => acc + (parseInt(curr.age) || 0), 0) / customers.length)
                : 0;

            const recentCustomers = [...customers].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            return (
                <div className="space-y-6 fade-in">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Dashboard</h2>
                        <p className="text-slate-500 dark:text-slate-400">Overview of your operations</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard
                            title="Total Customers"
                            value={totalCustomers}
                            icon={<Users size={24} />}
                            subLabel="Active directory"
                        />
                        <StatCard
                            title="Total Staff"
                            value={totalStaff}
                            icon={<Briefcase size={24} />}
                            subLabel="Qualified personnel"
                        />
                        <StatCard
                            title="Day Shifts"
                            value={totalShiftD}
                            icon={<Sun size={24} />}
                            subLabel="Scheduled for Day"
                        />
                        <StatCard
                            title="Average Age"
                            value={avgAge}
                            icon={<Activity size={24} />}
                            subLabel="Customer demographic"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                                <Clock size={20} className="text-brand-500" />
                                Recent Customers
                            </h3>
                            {recentCustomers.length === 0 ? (
                                <p className="text-slate-400 text-center py-8">No recent activity</p>
                            ) : (
                                <div className="space-y-4">
                                    {recentCustomers.map(c => (
                                        <div key={c.id} className="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border border-transparent hover:border-slate-100 dark:hover:border-slate-700">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900/30 flex items-center justify-center text-brand-600 font-bold">
                                                    {c.customerName.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <p className="font-medium text-slate-800 dark:text-slate-200">{c.customerName}</p>
                                                    <p className="text-xs text-slate-500">{c.serviceType} • {c.location}</p>
                                                </div>
                                            </div>
                                            <span className="text-xs text-slate-400">
                                                {new Date(c.createdAt).toLocaleDateString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </Card>
                        <Card>
                            <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                                <CheckCircle size={20} className="text-emerald-500" />
                                Staff Availability
                            </h3>
                            <div className="space-y-4">
                                {staff.slice(0, 5).map(s => (
                                    <div key={s.id} className="flex items-center justify-between p-3 border-b border-slate-100 dark:border-slate-800 last:border-0">
                                        <div>
                                            <p className="font-medium text-slate-800 dark:text-slate-200">{s.staffName}</p>
                                            <p className="text-xs text-slate-500">{s.qualification}</p>
                                        </div>
                                        <Badge color={s.availability === 'Full-time' ? 'green' : (s.availability === 'Part-time' ? 'blue' : 'amber')}>
                                            {s.availability || 'N/A'}
                                        </Badge>
                                    </div>
                                ))}
                                {staff.length === 0 && <p className="text-slate-400 text-center py-8">No staff records</p>}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // 2. Customer Manager
        const CustomerManager = ({ customers, setCustomers, postToSheet }) => {
            const [view, setView] = useState('list'); // 'list' | 'form'
            const [isSaving, setIsSaving] = useState(false);

            const initialForm = {
                id: null,
                customerName: '',
                age: '',
                healthCondition: '',
                serviceType: 'NA',
                rate: '',
                serviceDate: '',
                shift: 'D',
                shiftTime: '',
                location: '',
                notes: '',
                createdAt: ''
            };

            const [formData, setFormData] = useState(initialForm);

            const handleEdit = (customer) => {
                setFormData(customer);
                setView('form');
            };

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this customer?')) {
                    try {
                        const originalCustomers = [...customers];
                        setCustomers(prev => prev.filter(c => c.id !== id)); // Optimistic update

                        await postToSheet({
                            sheet: 'customers',
                            action: 'delete',
                            payload: { id }
                        });
                    } catch (error) {
                        alert('Failed to delete. Please try again.');
                        // Revert could go here
                        console.error(error);
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);

                try {
                    const action = formData.id ? 'update' : 'add';
                    const payload = {
                        ...formData,
                        id: formData.id || Date.now(),
                        createdAt: formData.createdAt || new Date().toISOString()
                    };

                    await postToSheet({
                        sheet: 'customers',
                        action: action,
                        payload: payload
                    });

                    if (action === 'update') {
                        setCustomers(prev => prev.map(c => c.id === payload.id ? payload : c));
                    } else {
                        setCustomers(prev => [payload, ...prev]);
                    }

                    setView('list');
                    setFormData(initialForm);
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("Failed to save data. " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            if (view === 'form') {
                return (
                    <div className="fade-in max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                                {formData.id ? 'Edit Customer' : 'New Customer'}
                            </h2>
                            <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }}>Cancel</Button>
                        </div>
                        <Card>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Customer Name" name="customerName" value={formData.customerName} onChange={e => setFormData({ ...formData, customerName: e.target.value })} required placeholder="e.g. Somchai Jai-dee" />
                                </div>
                                <Input label="Age" type="number" name="age" value={formData.age} onChange={e => setFormData({ ...formData, age: e.target.value })} placeholder="e.g. 65" />
                                <Input label="Health Condition" name="healthCondition" value={formData.healthCondition} onChange={e => setFormData({ ...formData, healthCondition: e.target.value })} placeholder="e.g. Diabetes, Hypertension" />

                                <Select label="Service Type" name="serviceType" value={formData.serviceType} onChange={e => setFormData({ ...formData, serviceType: e.target.value })}
                                    options={[
                                        { value: 'NA', label: 'NA' },
                                        { value: 'Caregiver', label: 'Caregiver' },
                                        { value: 'Nurse', label: 'Nurse' },
                                        { value: 'Therapy', label: 'Therapy' }
                                    ]}
                                />

                                <Input label="Rate (THB)" type="number" name="rate" value={formData.rate} onChange={e => setFormData({ ...formData, rate: e.target.value })} placeholder="0.00" />

                                <Input label="Service Date" type="date" name="serviceDate" value={formData.serviceDate} onChange={e => setFormData({ ...formData, serviceDate: e.target.value })} />

                                <div className="grid grid-cols-2 gap-4">
                                    <Select label="Shift" name="shift" value={formData.shift} onChange={e => setFormData({ ...formData, shift: e.target.value })}
                                        options={[
                                            { value: 'D', label: 'Day (D)' },
                                            { value: 'N', label: 'Night (N)' }
                                        ]}
                                    />
                                    <Input label="Shift Time" name="shiftTime" value={formData.shiftTime} onChange={e => setFormData({ ...formData, shiftTime: e.target.value })} placeholder="e.g. 08:00 - 16:00" />
                                </div>

                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Location / Address" name="location" value={formData.location} onChange={e => setFormData({ ...formData, location: e.target.value })} placeholder="Address or Room No." />
                                </div>
                                <div className="col-span-1 md:col-span-2">
                                    <label className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5 block">Notes</label>
                                    <textarea
                                        className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                                        rows="3"
                                        value={formData.notes}
                                        onChange={e => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="Additional details..."
                                    ></textarea>
                                </div>

                                <div className="col-span-1 md:col-span-2 flex justify-end gap-4 mt-4">
                                    <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }} disabled={isSaving}>Cancel</Button>
                                    <Button type="submit" disabled={isSaving}>
                                        {isSaving ? (
                                            <>
                                                <span className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></span>
                                                Saving...
                                            </>
                                        ) : 'Save Customer'}
                                    </Button>
                                </div>
                            </form>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="fade-in space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Customers</h2>
                            <p className="text-slate-500 dark:text-slate-400">Manage patient and client records</p>
                        </div>
                        <Button onClick={() => setView('form')}><Plus size={20} /> Add Customer</Button>
                    </div>

                    {customers.length === 0 ? (
                        <div className="text-center py-20 bg-white dark:bg-dark-800 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <div className="inline-flex p-4 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 mb-4">
                                <Users size={40} />
                            </div>
                            <h3 className="text-lg font-medium text-slate-900 dark:text-white">No customers yet</h3>
                            <p className="text-slate-500 mb-6 max-w-sm mx-auto">Get started by adding your first customer to the system.</p>
                            <Button onClick={() => setView('form')}><Plus size={20} /> Add Customer</Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 gap-4">
                            {customers.map(customer => (
                                <Card key={customer.id} className="group hover:border-brand-500/50 transition-colors">
                                    <div className="flex flex-col md:flex-row justify-between gap-4">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-2">
                                                <h3 className="text-lg font-bold text-slate-800 dark:text-white">{customer.customerName}</h3>
                                                <Badge color={customer.shift === 'D' ? 'amber' : 'purple'}>{customer.shift === 'D' ? 'Day' : 'Night'}</Badge>
                                                <Badge color="blue">{customer.serviceType}</Badge>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-500 dark:text-slate-400 mt-3">
                                                <div className="flex items-center gap-2"><Activity size={16} /> Age: {customer.age}</div>
                                                <div className="flex items-center gap-2"><MapPin size={16} /> {customer.location || "No location"}</div>
                                                <div className="flex items-center gap-2"><Calendar size={16} /> {customer.serviceDate || "No Date"}</div>
                                                <div className="flex items-center gap-2"><Clock size={16} /> {customer.shiftTime || "Standard"}</div>
                                            </div>
                                            {customer.notes && (
                                                <p className="mt-3 text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg inline-block">
                                                    "{customer.notes}"
                                                </p>
                                            )}
                                        </div>
                                        <div className="flex md:flex-col justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                            <Button variant="secondary" className="!p-2 text-sm" onClick={() => handleEdit(customer)}><Edit size={16} /></Button>
                                            <Button variant="danger" className="!p-2 text-sm" onClick={() => handleDelete(customer.id)}><Trash2 size={16} /></Button>
                                        </div>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 3. Staff Manager
        const StaffManager = ({ staff, setStaff, postToSheet }) => {
            const [view, setView] = useState('list');
            const [isSaving, setIsSaving] = useState(false);

            const initialForm = {
                id: null,
                staffName: '',
                qualification: '',
                rate: '',
                availability: '', // Full-time, Part-time, Casual
                experience: '',
                address: '',
                phone: '',
                notes: '',
                createdAt: ''
            };

            const [formData, setFormData] = useState(initialForm);

            const handleEdit = (member) => {
                setFormData(member);
                setView('form');
            };

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this staff member?')) {
                    try {
                        setStaff(prev => prev.filter(s => s.id !== id));
                        await postToSheet({
                            sheet: 'staffs',
                            action: 'delete',
                            id: id
                        });
                    } catch (error) {
                        console.error(error);
                        alert("Failed to delete staff.");
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);

                try {
                    const action = formData.id ? 'update' : 'add';
                    const payload = {
                        ...formData,
                        id: formData.id || Date.now(),
                        createdAt: formData.createdAt || new Date().toISOString()
                    };

                    await postToSheet({
                        sheet: 'staffs',
                        action: action,
                        payload: payload
                    });

                    if (action === 'update') {
                        setStaff(prev => prev.map(s => s.id === payload.id ? payload : s));
                    } else {
                        setStaff(prev => [payload, ...prev]);
                    }

                    setView('list');
                    setFormData(initialForm);
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("Failed to save staff. " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            if (view === 'form') {
                return (
                    <div className="fade-in max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                                {formData.id ? 'Edit Staff' : 'New Staff'}
                            </h2>
                            <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }}>Cancel</Button>
                        </div>
                        <Card>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Staff Name" name="staffName" value={formData.staffName} onChange={e => setFormData({ ...formData, staffName: e.target.value })} required placeholder="e.g. Nurse Joy" />
                                </div>
                                <Input label="Qualification" name="qualification" value={formData.qualification} onChange={e => setFormData({ ...formData, qualification: e.target.value })} placeholder="e.g. RN, PN, NA" />
                                <Select label="Availability" name="availability" value={formData.availability} onChange={e => setFormData({ ...formData, availability: e.target.value })}
                                    options={[
                                        { value: 'Full-time', label: 'Full-time' },
                                        { value: 'Part-time', label: 'Part-time' },
                                        { value: 'Freelance', label: 'Freelance' }
                                    ]}
                                />

                                <Input label="Rate (THB)" type="number" name="rate" value={formData.rate} onChange={e => setFormData({ ...formData, rate: e.target.value })} placeholder="0.00" />
                                <Input label="Experience (Years)" name="experience" value={formData.experience} onChange={e => setFormData({ ...formData, experience: e.target.value })} placeholder="e.g. 5" />
                                <Input label="Phone" type="tel" name="phone" value={formData.phone} onChange={e => setFormData({ ...formData, phone: e.target.value })} placeholder="089-xxx-xxxx" />

                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Address" name="address" value={formData.address} onChange={e => setFormData({ ...formData, address: e.target.value })} placeholder="Full address" />
                                </div>

                                <div className="col-span-1 md:col-span-2">
                                    <label className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5 block">Notes</label>
                                    <textarea
                                        className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                                        rows="3"
                                        value={formData.notes}
                                        onChange={e => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="Skills, preferences..."
                                    ></textarea>
                                </div>

                                <div className="col-span-1 md:col-span-2 flex justify-end gap-4 mt-4">
                                    <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }} disabled={isSaving}>Cancel</Button>
                                    <Button type="submit" disabled={isSaving}>
                                        {isSaving ? (
                                            <>
                                                <span className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></span>
                                                Saving...
                                            </>
                                        ) : 'Save Staff'}
                                    </Button>
                                </div>
                            </form>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="fade-in space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Staff Management</h2>
                            <p className="text-slate-500 dark:text-slate-400">Manage team members and qualifications</p>
                        </div>
                        <Button onClick={() => setView('form')}><Plus size={20} /> Add Staff</Button>
                    </div>

                    {staff.length === 0 ? (
                        <div className="text-center py-20 bg-white dark:bg-dark-800 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <div className="inline-flex p-4 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 mb-4">
                                <Briefcase size={40} />
                            </div>
                            <h3 className="text-lg font-medium text-slate-900 dark:text-white">No staff added</h3>
                            <p className="text-slate-500 mb-6 max-w-sm mx-auto">Build your team by adding staff profiles to the system.</p>
                            <Button onClick={() => setView('form')}><Plus size={20} /> Add Staff</Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {staff.map(member => (
                                <Card key={member.id} className="relative group hover:border-brand-500/50 transition-colors flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl font-bold text-slate-600 dark:text-slate-300">
                                                {member.staffName.charAt(0).toUpperCase()}
                                            </div>
                                            <Badge color={member.availability === 'Full-time' ? 'green' : 'blue'}>
                                                {member.availability || 'N/A'}
                                            </Badge>
                                        </div>
                                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-1">{member.staffName}</h3>
                                        <p className="text-brand-600 dark:text-brand-400 text-sm font-medium mb-4">{member.qualification}</p>

                                        <div className="space-y-2 text-sm text-slate-500 dark:text-slate-400">
                                            <div className="flex items-center gap-2"><Briefcase size={16} /> {member.experience} Year(s) Exp.</div>
                                            <div className="flex items-center gap-2"><MapPin size={16} /> {member.address || "No Address"}</div>
                                            <div className="flex items-center gap-2"><Users size={16} /> {member.phone || "No Phone"}</div>
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-6 pt-4 border-t border-slate-100 dark:border-slate-800">
                                        <Button variant="ghost" className="!p-2 text-sm" onClick={() => handleEdit(member)}><Edit size={16} /></Button>
                                        <Button variant="ghost" className="!p-2 text-sm text-red-500 hover:text-red-600 hover:bg-red-50" onClick={() => handleDelete(member.id)}><Trash2 size={16} /></Button>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };


        // --- Layout & Main App ---

        const API_URL = "https://script.google.com/macros/s/AKfycbyAaG48aH_oGIwzTq3_F2WqCU1CaEsDB-6Ntyhmd_e8T0URWE0iOofw_jRX1fj-ZU9Cag/exec";

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [loadError, setLoadError] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);

            // Data State
            const [customers, setCustomers] = useState([]);
            const [staff, setStaff] = useState([]);

            const postToSheet = async (body) => {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    },
                    body: JSON.stringify(body)
                });
                return res.json();
            };

            // Effects: Fetch Data from Google Sheets
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setIsLoading(true);
                        // Fetch both endpoints in parallel
                        const [custRes, staffRes] = await Promise.all([
                            fetch(API_URL + "?sheet=customers"),
                            fetch(API_URL + "?sheet=staffs")
                        ]);

                        if (!custRes.ok || !staffRes.ok) throw new Error("Failed to fetch data from API");

                        const custData = await custRes.json();
                        const staffData = await staffRes.json();

                        // Ensure data is array
                        setCustomers(Array.isArray(custData) ? custData : []);
                        setStaff(Array.isArray(staffData) ? staffData : []);
                    } catch (err) {
                        console.error("API Error:", err);
                        setLoadError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchData();
            }, []);

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);



            const NavItem = ({ id, icon, label }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${activeTab === id
                        ? 'bg-brand-600 text-white shadow-lg shadow-brand-600/30'
                        : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white'
                        }`}
                >
                    <div className={activeTab === id ? 'text-white' : 'group-hover:scale-110 transition-transform'}>
                        {icon}
                    </div>
                    {isSidebarOpen && <span className="font-medium fade-in">{label}</span>}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
                    {/* Sidebar */}
                    <aside className={`flex-shrink-0 bg-white dark:bg-dark-950 border-r border-slate-200 dark:border-slate-800 flex flex-col transition-all duration-300 ease-in-out ${isSidebarOpen ? 'w-64' : 'w-0 overflow-hidden border-none'}`}>
                        <div className="p-6">
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-indigo-600 whitespace-nowrap flex items-center gap-2">
                                <Home size={28} className="text-brand-600" />
                                อุ่นใจ โฮมแคร์
                            </h1>
                            <p className="text-xs text-slate-400 mt-1 font-medium tracking-wide whitespace-nowrap">ระบบจัดการข้อมูลลูกค้าและพนักงาน</p>
                        </div>

                        <nav className="flex-1 px-4 space-y-2 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" icon={<LayoutDashboard size={20} />} label="Dashboard" />
                            <NavItem id="customers" icon={<Users size={20} />} label="Customers" />
                            <NavItem id="staff" icon={<Briefcase size={20} />} label="Staff" />
                        </nav>

                        <div className="p-4 border-t border-slate-100 dark:border-slate-800">
                            <button
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                            >
                                <span className="text-sm font-medium whitespace-nowrap">Theme</span>
                                {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-auto relative mainBG">
                        {/* Header Area */}
                        <header className="sticky top-0 z-20 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-md px-8 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors"
                                    title={isSidebarOpen ? "Hid Sidebar" : "Show Sidebar"}
                                >
                                    <Menu size={24} />
                                </button>
                                <h1 className="text-xl font-bold text-slate-800 dark:text-white capitalize">
                                    {activeTab}
                                </h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="text-sm text-slate-500 dark:text-slate-400">
                                    {new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </div>
                                <div className="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center font-bold">
                                    A
                                </div>
                            </div>
                        </header>

                        <div className="p-8 max-w-7xl mx-auto pb-20 mainBG">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center h-64 fade-in">
                                    <div className="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mb-4"></div>
                                    <p className="text-slate-500 font-medium">Loading data from Cloud...</p>
                                </div>
                            ) : loadError ? (
                                <div className="text-center p-10 bg-red-50 text-red-600 rounded-xl border border-red-200">
                                    <h3 className="font-bold">Connection Error</h3>
                                    <p>{loadError}</p>
                                    <Button onClick={() => window.location.reload()} className="mt-4 mx-auto" variant="secondary">Retry</Button>
                                </div>
                            ) : (
                                <>
                                    {activeTab === 'dashboard' && <Dashboard customers={customers} staff={staff} />}
                                    {activeTab === 'customers' && <CustomerManager customers={customers} setCustomers={setCustomers} postToSheet={postToSheet} />}
                                    {activeTab === 'staff' && <StaffManager staff={staff} setStaff={setStaff} postToSheet={postToSheet} />}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>