<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management System</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            color: #1e293b;
            transition: background-color 0.3s, color 0.3s;
        }

        .dark body {
            background-color: #020617;
            color: #f1f5f9;
        }

        .mainBG {
            background-color: #f2f2f2;
        }

        .dark .mainBG {
            background-color: #0f172a;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="antialiased min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Date Utilities ---
        const formatThaiDate = (dateStr) => {
            if (!dateStr) return "ไม่มีข้อมูล";
            try {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateStr;
            }
        };

        // --- Icon Wrapper & Definitions ---
        // Fix for Lucide icons in standalone React
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            const iconData = lucide.icons[iconName];

            if (!iconData) return null;

            // Handle Lucide's array structure for icon definitions
            // usually: [ ['path', {d:...}], ... ]
            if (Array.isArray(iconData)) {
                const svgContent = iconData.map(([tag, attrs]) => {
                    const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' ');
                    // Self-closing tags in SVG string or strict open/close
                    return `<${tag} ${attrStr}></${tag}>`;
                }).join('');

                return (
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width={size}
                        height={size}
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        className={className}
                        dangerouslySetInnerHTML={{ __html: svgContent }}
                        style={{ display: 'inline-block', verticalAlign: 'middle' }}
                    />
                );
            }

            return null;
        };

        const LayoutDashboard = (props) => <Icon name="LayoutDashboard" {...props} />;
        const Users = (props) => <Icon name="Users" {...props} />;
        const Briefcase = (props) => <Icon name="Briefcase" {...props} />;
        const Plus = (props) => <Icon name="Plus" {...props} />;
        const Trash2 = (props) => <Icon name="Trash2" {...props} />;
        const Edit = (props) => <Icon name="Edit" {...props} />;
        const Search = (props) => <Icon name="Search" {...props} />;
        const Moon = (props) => <Icon name="Moon" {...props} />;
        const Sun = (props) => <Icon name="Sun" {...props} />;
        const CheckCircle = (props) => <Icon name="CheckCircle" {...props} />;
        const XCircle = (props) => <Icon name="XCircle" {...props} />;
        const Calendar = (props) => <Icon name="Calendar" {...props} />;
        const MapPin = (props) => <Icon name="MapPin" {...props} />;
        const Clock = (props) => <Icon name="Clock" {...props} />;
        const Activity = (props) => <Icon name="Activity" {...props} />;
        const Menu = (props) => <Icon name="Menu" {...props} />;
        const X = (props) => <Icon name="X" {...props} />;
        const Home = (props) => <Icon name="Home" {...props} />;
        const ChevronLeft = (props) => <Icon name="ChevronLeft" {...props} />;
        const ChevronRight = (props) => <Icon name="ChevronRight" {...props} />;
        const Coins = (props) => <Icon name="Coins" {...props} />;
        const BookHeart = (props) => <Icon name="BookHeart" {...props} />;
        const Phone = (props) => <Icon name="Phone" {...props} />;
        const FileText = (props) => <Icon name="FileText" {...props} />;
        const ChevronDown = (props) => <Icon name="ChevronDown" {...props} />;


        // --- UI Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`glass-panel rounded-2xl shadow-sm p-6 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", type = "button" }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-medium transition-all duration-200 flex items-center gap-2 active:scale-95";
            const variants = {
                primary: "bg-brand-600 text-white hover:bg-brand-500 shadow-lg shadow-brand-500/30",
                secondary: "bg-white dark:bg-dark-800 text-slate-700 dark:text-slate-200 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50",
                danger: "bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30",
                ghost: "text-slate-500 hover:text-brand-600 dark:text-slate-400 dark:hover:text-brand-400 hover:bg-slate-100 dark:hover:bg-slate-800"
            };
            return (
                <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, name, value, onChange, placeholder, type = "text", required = false }) => (
            <div className="flex flex-col gap-1.5">
                {label && <label className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</label>}
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    required={required}
                    placeholder={placeholder}
                    className="w-full h-[46px] px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white appearance-none"
                />
            </div>
        );

        const Select = ({ label, name, value, onChange, options, required = false }) => (
            <div className="flex flex-col gap-1.5">
                {label && <label className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</label>}
                <div className="relative">
                    <select
                        name={name}
                        value={value}
                        onChange={onChange}
                        required={required}
                        className="w-full h-[46px] px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white appearance-none pr-10"
                    >
                        <option value="" disabled>Select {label}</option>
                        {options.map(opt => (
                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                        ))}
                    </select>
                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                        <ChevronDown size={18} />
                    </div>
                </div>
            </div>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
                green: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300",
                purple: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300",
                amber: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-semibold ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            );
        };

        // --- Stats Card Component ---
        const StatCard = ({ title, value, icon, trend, subLabel }) => (
            <Card className="relative overflow-hidden group hover:border-brand-500/30 transition-all">
                <div className="flex justify-between items-start z-10 relative">
                    <div>
                        <p className="text-slate-500 dark:text-slate-400 font-medium mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-slate-800 dark:text-white mb-1">{value}</h3>
                        {subLabel && <p className="text-sm text-slate-400 dark:text-slate-500">{subLabel}</p>}
                    </div>
                    <div className="p-3 bg-brand-50 dark:bg-brand-900/20 text-brand-600 rounded-xl group-hover:scale-110 transition-transform">
                        {icon}
                    </div>
                </div>
                {/* Decorative background blob */}
                <div className="absolute -bottom-4 -right-4 w-24 h-24 bg-brand-500/5 rounded-full blur-2xl group-hover:bg-brand-500/10 transition-colors"></div>
            </Card>
        );


        // --- Views ---

        // 1. Dashboard
        const Dashboard = ({ customers, staff }) => {
            // Count only customers currently being served (not expired)
            const activeCustomers = customers.filter(customer => {
                if (!customer.serviceDate || !customer.shiftTime) return false;
                const serviceStartDate = new Date(customer.serviceDate);
                const careDays = parseInt(customer.shiftTime) || 0;
                const serviceEndDate = new Date(serviceStartDate);
                serviceEndDate.setDate(serviceStartDate.getDate() + careDays);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return today <= serviceEndDate;
            }).length;

            const totalStaff = staff.length;
            const totalShiftD = customers.filter(c => c.shift === 'D').length;

            // Calculate some simple stats
            const avgAge = customers.length > 0
                ? Math.round(customers.reduce((acc, curr) => acc + (parseInt(curr.age) || 0), 0) / customers.length)
                : 0;

            const recentCustomers = [...customers].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            const recentStaff = [...staff].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            return (
                <div className="space-y-6 fade-in">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Dashboard</h2>
                        <p className="text-slate-500 dark:text-slate-400">Overview of your operations</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard
                            key="active-customers"
                            title="Active Customer"
                            value={activeCustomers}
                            icon={<Users size={24} />}
                            subLabel="Currently being served"
                        />
                        <StatCard
                            key="total-staff"
                            title="Total Staff"
                            value={totalStaff}
                            icon={<Briefcase size={24} />}
                            subLabel="Qualified personnel"
                        />
                        <StatCard
                            key="day-shifts"
                            title="Day Shifts"
                            value={totalShiftD}
                            icon={<Sun size={24} />}
                            subLabel="Scheduled for Day"
                        />
                        <StatCard
                            key="average-age"
                            title="Average Age"
                            value={avgAge}
                            icon={<Activity size={24} />}
                            subLabel="Customer demographic"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                                <Clock size={20} className="text-brand-500" />
                                Recent Customers
                            </h3>
                            {recentCustomers.length === 0 ? (
                                <p className="text-slate-400 text-center py-8">No recent activity</p>
                            ) : (
                                <div className="space-y-4">
                                    {recentCustomers.map(c => (
                                        <div key={c.id} className="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border border-transparent hover:border-slate-100 dark:hover:border-slate-700">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900/30 flex items-center justify-center text-brand-600 font-bold">
                                                    {c.customerName.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <p className="font-medium text-slate-800 dark:text-slate-200">{c.customerName}</p>
                                                    <p className="text-xs text-slate-500">{c.serviceType} • {c.healthCondition}</p>
                                                </div>
                                            </div>
                                            <span className="text-xs text-slate-400">
                                                {new Date(c.createdAt).toLocaleDateString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </Card>
                        <Card>
                            <h3 className="font-bold text-lg mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                                <CheckCircle size={20} className="text-emerald-500" />
                                Staff Availability
                            </h3>
                            <div className="space-y-4">
                                {recentStaff.map(s => (
                                    <div key={s.id} className="flex items-center justify-between p-3 border-b border-slate-100 dark:border-slate-800 last:border-0">
                                        <div>
                                            <p className="font-medium text-slate-800 dark:text-slate-200">{s.staffName}</p>
                                            <p className="text-xs text-slate-500">{s.notes}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <Badge key={`${s.id}-duty`} color={s.duty === 'RN' ? 'green' : (s.duty === 'PN' ? 'blue' : 'amber')}>
                                                {s.duty || '???'}
                                            </Badge>
                                            <Badge key={`${s.id}-employment`} color={s.employmentType === 'Full-Time' ? 'green' : (s.employmentType === 'Part-Time' ? 'blue' : 'amber')}>
                                                {s.employmentType || '???'}
                                            </Badge>
                                        </div>
                                    </div>
                                ))}
                                {staff.length === 0 && <p className="text-slate-400 text-center py-8">No staff records</p>}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // 2. Customer Manager
        const CustomerManager = ({ customers, setCustomers, postToSheet }) => {
            const [view, setView] = useState('list'); // 'list' | 'form'
            const [isSaving, setIsSaving] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [showActiveOnly, setShowActiveOnly] = useState(false);
            const [formTitle, setFormTitle] = useState('สร้างบริการลูกค้าใหม่');

            const initialForm = {
                id: null,
                customerName: '',
                birthYear: '',
                healthCondition: '',
                serviceType: 'NA',
                rate: '',
                serviceDate: '',
                shift: 'D',
                shiftTime: '',
                location: '',
                notes: '',
                createdAt: '',
            };

            const [formData, setFormData] = useState(initialForm);

            const handleEdit = (customer, title = 'Edit Customer') => {
                setFormTitle(title);
                let normalizedDate = customer.serviceDate || "";
                if (normalizedDate) {
                    try {
                        const d = new Date(normalizedDate);
                        if (!isNaN(d.getTime())) {
                            // Use local components to avoid timezone shifting
                            const y = d.getFullYear();
                            const m = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            normalizedDate = `${y}-${m}-${day}`;
                        }
                    } catch (e) {
                        console.warn("Date normalization failed", e);
                    }
                }
                setFormData({
                    ...customer,
                    serviceDate: normalizedDate
                });
                setView('form');
            };

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this customer?')) {
                    try {
                        const originalCustomers = [...customers];
                        const c = customers.find(item => item.id === id);
                        if (!c) return;

                        setCustomers(prev => prev.filter(item => item.id !== id)); // Optimistic update

                        // Convert Age -> BirthYear for storage consistency
                        const currentYear = new Date().getFullYear();
                        const birthYear = c.age ? (currentYear - parseInt(c.age)) : '';

                        const payload = {
                            id: c.id,
                            customerName: c.customerName,
                            birthYear: birthYear,
                            healthCondition: c.healthCondition,
                            serviceType: c.serviceType,
                            rate: c.rate,
                            serviceDate: c.serviceDate ? (() => {
                                const d = new Date(c.serviceDate);
                                if (isNaN(d.getTime())) return c.serviceDate;
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                return `${y}-${m}-${day}`;
                            })() : "",
                            shift: c.shift,
                            shiftTime: c.shiftTime,
                            location: c.location,
                            notes: c.notes,
                            createdAt: c.createdAt,
                            serviceCode: c.serviceCode
                        };

                        await postToSheet({
                            sheet: 'customers',
                            action: 'delete',
                            payload: payload
                        });
                    } catch (error) {
                        alert('Failed to delete. Please try again.');
                        // Revert could go here
                        console.error(error);
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);

                try {
                    let action = "add";
                    if (formData.id) {
                        if (formTitle === "แก้ไขบริการลูกค้า") {
                            action = "edit";
                        } else {
                            action = "update";
                        }
                    }

                    // Convert Age -> BirthYear for storage
                    const currentYear = new Date().getFullYear();
                    const birthYear = formData.age ? (currentYear - parseInt(formData.age)) : ''; // Simple year calc

                    // Generate Service Code for Add or Update
                    let serviceCode = formData.serviceCode;
                    if (action === "add" || action === "update") {
                        const prefixes = {
                            'NA': 'NA',
                            'Caregiver': 'CG',
                            'Nurse': 'RN',
                            'Therapy': 'TH'
                        };
                        const prefix = prefixes[formData.serviceType] || 'SV';
                        const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
                        serviceCode = `${prefix}-${randomPart}`;
                    }

                    const serviceDate = formData.serviceDate || (() => {
                        const now = new Date();
                        const y = now.getFullYear();
                        const m = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        return `${y}-${m}-${day}`;
                    })();

                    const payload = {
                        id: formData.id || Date.now(),
                        customerName: formData.customerName,
                        birthYear: birthYear,
                        healthCondition: formData.healthCondition,
                        serviceType: formData.serviceType,
                        rate: formData.rate,
                        serviceDate: serviceDate,
                        shift: formData.shift,
                        shiftTime: formData.shiftTime,
                        location: formData.location,
                        notes: formData.notes,
                        createdAt: formData.createdAt || new Date().toISOString(),
                        serviceCode: serviceCode
                    };

                    await postToSheet({
                        sheet: 'customers',
                        action: action,
                        payload: payload
                    });

                    if (action === 'update' || action === 'edit') {
                        setCustomers(prev => prev.map(c => c.id === payload.id ? { ...formData, ...payload } : c)); //Merge ข้อมูลใหม่อีกครั้งก่อน set
                    } else {
                        setCustomers(prev => [{ ...formData, ...payload }, ...prev]); //Merge ข้อมูลใหม่อีกครั้งก่อน set
                    }

                    setView('list');
                    setFormData(initialForm);
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("Failed to " + action + " data. " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            if (view === 'form') {
                return (
                    <div className="fade-in max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                                {formTitle}
                            </h2>
                            <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }}>Cancel</Button>
                        </div>
                        <Card>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Customer Name" name="customerName" value={formData.customerName} onChange={e => setFormData({ ...formData, customerName: e.target.value })} required placeholder="e.g. Somchai Jai-dee" />
                                </div>
                                <Input label="Age" type="number" name="age" value={formData.age} onChange={e => setFormData({ ...formData, age: e.target.value })} placeholder="e.g. 65" />
                                <Input label="Health Condition" name="healthCondition" value={formData.healthCondition} onChange={e => setFormData({ ...formData, healthCondition: e.target.value })} placeholder="e.g. Diabetes, Hypertension" />

                                <Select label="Service Type" name="serviceType" value={formData.serviceType} onChange={e => setFormData({ ...formData, serviceType: e.target.value })}
                                    options={[
                                        { value: 'NA', label: 'NA' },
                                        { value: 'Caregiver', label: 'Caregiver' },
                                        { value: 'Nurse', label: 'Nurse' },
                                        { value: 'Therapy', label: 'Therapy' }
                                    ]}
                                />

                                <div className="grid grid-cols-2 gap-4">
                                    <Select label="Shift" name="shift" value={formData.shift} onChange={e => setFormData({ ...formData, shift: e.target.value })}
                                        options={[
                                            { value: 'D', label: 'Day (D)' },
                                            { value: 'N', label: 'Night (N)' },
                                            { value: 'F', label: 'Full-Time (F)' }
                                        ]}
                                    />
                                    <Input label="Rate (THB)" type="number" name="rate" value={formData.rate} onChange={e => setFormData({ ...formData, rate: e.target.value })} placeholder="0.00" />
                                </div>

                                <Input label="Service Date" type="date" name="serviceDate" value={formData.serviceDate} onChange={e => setFormData({ ...formData, serviceDate: e.target.value })} />

                                <Input label="Shift Time" type="number" name="shiftTime" value={formData.shiftTime} onChange={e => setFormData({ ...formData, shiftTime: e.target.value })} placeholder="e.g. 7 days" />


                                <div className="col-span-1 md:col-span-2">
                                    <Input label="Location / Address" name="location" value={formData.location} onChange={e => setFormData({ ...formData, location: e.target.value })} placeholder="Address or Room No." />
                                </div>
                                <div className="col-span-1 md:col-span-2">
                                    <label className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5 block">Notes</label>
                                    <textarea
                                        className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                                        rows="3"
                                        value={formData.notes}
                                        onChange={e => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="Additional details..."
                                    ></textarea>
                                </div>

                                <div className="col-span-1 md:col-span-2 flex justify-end gap-4 mt-4">
                                    <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }} disabled={isSaving}>Cancel</Button>
                                    <Button type="submit" disabled={isSaving}>
                                        {isSaving ? (
                                            <>
                                                <span className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></span>
                                                Saving...
                                            </>
                                        ) : 'Save Customer'}
                                    </Button>
                                </div>
                            </form>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="fade-in space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">ระบบจัดการลูกค้า</h2>
                            <p className="text-slate-500 dark:text-slate-400">จัดการรายชื่อขัอมูลลูกค้าและการบริการ</p>
                        </div>
                        <Button onClick={() => setView('form')}><Plus size={20} /> สร้างบริการลูกค้าใหม่</Button>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 items-stretch md:items-center">
                        <div className="relative flex-1">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <Search size={20} />
                            </div>
                            <input
                                type="text"
                                placeholder="ค้นหารายชื่อลูกค้า..."
                                className="w-full pl-10 pr-4 py-3 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white shadow-sm"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                        </div>
                        <button
                            onClick={() => setShowActiveOnly(!showActiveOnly)}
                            className={`flex items-center gap-2 px-4 py-3 rounded-xl border transition-all duration-200 font-medium whitespace-nowrap shadow-sm ${showActiveOnly
                                ? 'bg-emerald-500 border-emerald-600 text-white active-shadow'
                                : 'bg-white dark:bg-dark-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800'
                                }`}
                        >
                            <Activity size={18} />
                            เฉพาะที่กำลังให้บริการ
                        </button>
                    </div>

                    {customers.length === 0 ? (
                        <div className="text-center py-20 bg-white dark:bg-dark-800 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <div className="inline-flex p-4 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 mb-4">
                                <Users size={40} />
                            </div>
                            <h3 className="text-lg font-medium text-slate-900 dark:text-white">No customers yet</h3>
                            <p className="text-slate-500 mb-6 max-w-sm mx-auto">Get started by adding your first customer to the system.</p>
                            <Button onClick={() => setView('form')}><Plus size={20} /> Add Customer</Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 gap-4">
                            {[...customers]
                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                .filter(customer => {
                                    // Base search filter
                                    const matchesSearch = customer.customerName.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                        (customer.serviceCode && String(customer.serviceCode).toLowerCase().includes(searchQuery.toLowerCase())) ||
                                        (customer.location && customer.location.toLowerCase().includes(searchQuery.toLowerCase())) ||
                                        (customer.healthCondition && customer.healthCondition.toLowerCase().includes(searchQuery.toLowerCase())) ||
                                        (customer.notes && customer.notes.toLowerCase().includes(searchQuery.toLowerCase()));

                                    if (!matchesSearch) return false;

                                    // Active only filter
                                    if (showActiveOnly) {
                                        const serviceStartDate = new Date(customer.serviceDate);
                                        const careDays = parseInt(customer.shiftTime) || 0;
                                        const serviceEndDate = new Date(serviceStartDate);
                                        serviceEndDate.setDate(serviceStartDate.getDate() + careDays);

                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);

                                        const hasData = customer.serviceDate && customer.shiftTime;
                                        const isExpired = hasData && today > serviceEndDate;

                                        return !isExpired && hasData;
                                    }

                                    return true;
                                })
                                .map(customer => {
                                    const serviceStartDate = new Date(customer.serviceDate);
                                    const careDays = parseInt(customer.shiftTime) || 0;
                                    const serviceEndDate = new Date(serviceStartDate);
                                    serviceEndDate.setDate(serviceStartDate.getDate() + careDays);

                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0); // Normalize to start of day

                                    const hasData = customer.serviceDate && customer.shiftTime;
                                    const isExpired = hasData && today > serviceEndDate;

                                    const statusClasses = isExpired
                                        ? "bg-red-50/80 dark:bg-red-900/20 border-red-200 dark:border-red-800"
                                        : (hasData ? "bg-emerald-50/80 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800" : "");

                                    return (
                                        <Card key={customer.id} className={`group hover:border-brand-500/50 transition-all duration-300 ${statusClasses}`}>
                                            <div className="flex flex-col md:flex-row justify-between gap-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center justify-between gap-3 mb-2">
                                                        <div className="flex items-center gap-3">
                                                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">{customer.customerName} ({customer.serviceCode || 'N/A'})</h3>
                                                            <Badge color={customer.shift === 'D' ? 'amber' : (customer.shift === 'N' ? 'purple' : (customer.shift === 'F' ? 'green' : 'blue'))}>
                                                                {customer.shift === 'D' ? 'Day' : (customer.shift === 'N' ? 'Night' : (customer.shift === 'F' ? 'Full-Time' : customer.shift))}
                                                            </Badge>
                                                            <Badge color="blue">{customer.serviceType}</Badge>
                                                        </div>
                                                        <Button
                                                            variant="primary"
                                                            className="hidden md:flex !px-3 !py-1 text-xs font-semibold gap-1"
                                                            onClick={() => handleEdit(customer, 'เพิ่มบริการลูกค้า')}
                                                        >
                                                            <Plus size={14} /> เพิ่มบริการลูกค้า
                                                        </Button>
                                                    </div>
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-500 dark:text-slate-400 mt-3">
                                                        <div className="flex items-center gap-2"><Activity size={16} /> อายุ: {customer.age}</div>
                                                        <div className="flex items-center gap-2"><BookHeart size={16} />  อาการ: {customer.healthCondition || "ไม่มีอาการ"}</div>
                                                        <div className="flex items-center gap-2">
                                                            <Calendar size={16} /> วันเริ่มใช้บริการ: {formatThaiDate(customer.serviceDate)}
                                                        </div>
                                                        <div className="flex items-center gap-2"><Calendar size={16} />  จำนวนวันที่ดูแล: {customer.shiftTime || "1 วัน"}</div>
                                                    </div>
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-slate-500 dark:text-slate-400 mt-3">
                                                        <div className="flex items-center gap-2 md:col-span-3"><MapPin size={16} /> สถานที่ให้บริการ: {customer.location || "No location"}</div>
                                                        <div className="flex items-center gap-2">
                                                            <Coins size={16} />  สถานะ:
                                                            <span className={`font-bold ${isExpired ? 'text-red-600 dark:text-red-400' : (hasData ? 'text-emerald-600 dark:text-emerald-400' : '')}`}>
                                                                {isExpired ? "จบงาน" : (hasData ? "กำลังให้บริการ" : "-")}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    {customer.notes && (
                                                        <p className="mt-3 text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg inline-block">
                                                            "{customer.notes}"
                                                        </p>
                                                    )}
                                                </div>
                                                <div className="flex md:flex-col justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <Button variant="secondary" className="!p-2 text-sm" onClick={() => handleEdit(customer, 'แก้ไขบริการลูกค้า')}><Edit size={16} /></Button>
                                                    <Button variant="danger" className="!p-2 text-sm" onClick={() => handleDelete(customer.id)}><Trash2 size={16} /></Button>
                                                </div>
                                            </div>
                                        </Card>
                                    );
                                })}
                        </div>
                    )}
                </div>
            );
        };

        // 3. Staff Manager
        const StaffManager = ({ staff, setStaff, postToSheet }) => {
            const [view, setView] = useState('list');
            const [isSaving, setIsSaving] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');

            const initialForm = {
                id: null,
                pid: '',
                staffName: '',
                phone: '',
                address: '',
                position: 'staff',
                duty: 'NA',
                experience: '',
                employmentType: 'Full-Time',
                rate: '',
                bankInfo: '',
                notes: '',
                createdAt: ''
            };

            const [formData, setFormData] = useState(initialForm);

            const handleEdit = (member) => {
                setFormData(member);
                setView('form');
            };

            const handleDelete = async (id) => {
                if (confirm('Are you sure you want to delete this staff member?')) {
                    try {
                        setStaff(prev => prev.filter(s => s.id !== id));
                        await postToSheet({
                            sheet: 'staffs',
                            action: 'delete',
                            id: id
                        });
                    } catch (error) {
                        console.error(error);
                        alert("Failed to delete staff.");
                    }
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);

                try {
                    const action = formData.id ? 'update' : 'add';
                    const payload = {
                        pid: formData.pid,
                        staffName: formData.staffName,
                        phone: "'" + formData.phone,
                        address: formData.address,
                        position: formData.position,
                        duty: formData.duty,
                        experience: formData.experience,
                        employmentType: formData.employmentType,
                        rate: formData.rate,
                        bankInfo: formData.bankInfo,
                        notes: formData.notes,
                        createdAt: formData.createdAt || new Date().toISOString()
                    };

                    await postToSheet({
                        sheet: 'staffs',
                        action: action,
                        payload: payload
                    });

                    if (action === 'update') {
                        setStaff(prev => prev.map(s => s.id === payload.id ? payload : s));
                    } else {
                        setStaff(prev => [payload, ...prev]);
                    }

                    setView('list');
                    setFormData(initialForm);
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("Failed to save staff. " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            if (view === 'form') {
                return (
                    <div className="fade-in max-w-3xl mx-auto">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">
                                {formData.id ? 'แก้ไขข้อมูลพนักงาน' : 'เพิ่มพนักงานใหม่'}
                            </h2>
                            <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }}>ยกเลิก</Button>
                        </div>
                        <Card>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="col-span-1 md:col-span-2">
                                    <Input label="เลขบัตรประชาชน 13 หลัก" name="pid" value={formData.pid} onChange={e => setFormData({ ...formData, pid: e.target.value })} required placeholder="x-xxxx-xxxxx-xx-x" />
                                </div>
                                <Input label="ชื่อ-นามสกุล" name="staffName" value={formData.staffName} onChange={e => setFormData({ ...formData, staffName: e.target.value })} required placeholder="ชื่อจริง-นามสกุล" />
                                <Input label="เบอร์โทรติดต่อ" type="tel" name="phone" value={formData.phone} onChange={e => setFormData({ ...formData, phone: e.target.value })} required placeholder="08x-xxx-xxxx" />

                                <div className="col-span-1 md:col-span-2">
                                    <Input label="ที่อยู่" name="address" value={formData.address} onChange={e => setFormData({ ...formData, address: e.target.value })} placeholder="ที่อยู่ปัจจุบัน" />
                                </div>

                                <Select label="ตำแหน่ง" name="position" value={formData.position} onChange={e => setFormData({ ...formData, position: e.target.value })}
                                    options={[
                                        { value: 'staff', label: 'Staff' },
                                        { value: 'admin', label: 'Admin' },
                                        { value: 'CEO', label: 'CEO' },
                                        { value: 'owner', label: 'Owner' }
                                    ]}
                                />
                                <Select label="หน้าที่" name="duty" value={formData.duty} onChange={e => setFormData({ ...formData, duty: e.target.value })}
                                    options={[
                                        { value: 'RN', label: 'RN' },
                                        { value: 'PN', label: 'PN' },
                                        { value: 'NA', label: 'NA' }
                                    ]}
                                />

                                <Input label="ประสพการณ์" name="experience" value={formData.experience} onChange={e => setFormData({ ...formData, experience: e.target.value })} placeholder="เช่น 5 ปี" />
                                <Select label="ประเภทเวลาทำงาน" name="employmentType" value={formData.employmentType} onChange={e => setFormData({ ...formData, employmentType: e.target.value })}
                                    options={[
                                        { value: 'Full-Time', label: 'Full-Time' },
                                        { value: 'Part-Time', label: 'Part-Time' },
                                        { value: 'Freelance', label: 'Freelance' }
                                    ]}
                                />

                                <Input label="ค่าแรง" type="number" name="rate" value={formData.rate} onChange={e => setFormData({ ...formData, rate: e.target.value })} placeholder="0.00" />
                                <Input label="ชื่อบัญชีธนาคาร+เลขที่บัญชี" name="bankInfo" value={formData.bankInfo} onChange={e => setFormData({ ...formData, bankInfo: e.target.value })} placeholder="ไทยพาณิชย์ 123-x-xxxxx-x" />

                                <div className="col-span-1 md:col-span-2">
                                    <label className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5 block">Note</label>
                                    <textarea
                                        className="w-full px-4 py-2.5 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white"
                                        rows="3"
                                        value={formData.notes}
                                        onChange={e => setFormData({ ...formData, notes: e.target.value })}
                                        placeholder="ข้อมูลเพิ่มเติม..."
                                    ></textarea>
                                </div>

                                <div className="col-span-1 md:col-span-2 flex justify-end gap-4 mt-4">
                                    <Button variant="secondary" onClick={() => { setView('list'); setFormData(initialForm); }} disabled={isSaving}>Cancel</Button>
                                    <Button type="submit" disabled={isSaving}>
                                        {isSaving ? (
                                            <>
                                                <span className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></span>
                                                Saving...
                                            </>
                                        ) : 'บันทึกข้อมูล'}
                                    </Button>
                                </div>
                            </form>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="fade-in space-y-6">
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-white">ระบบจัดการพนักงาน</h2>
                            <p className="text-slate-500 dark:text-slate-400">จัดการรายชื่อพนักงานและข้อมูลพนักงาน</p>
                        </div>
                        <Button onClick={() => setView('form')}><Plus size={20} /> เพิ่มพนักงานใหม่</Button>
                    </div>

                    <div className="relative">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                            <Search size={20} />
                        </div>
                        <input
                            type="text"
                            placeholder="ค้นหารายชื่อพนักงาน..."
                            className="w-full pl-10 pr-4 py-3 rounded-xl bg-white dark:bg-dark-800 border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all dark:text-white shadow-sm"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    {staff.length === 0 ? (
                        <div className="text-center py-20 bg-white dark:bg-dark-800 rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                            <div className="inline-flex p-4 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-400 mb-4">
                                <Briefcase size={40} />
                            </div>
                            <h3 className="text-lg font-medium text-slate-900 dark:text-white">No staff added</h3>
                            <p className="text-slate-500 mb-6 max-w-sm mx-auto">Build your team by adding staff profiles to the system.</p>
                            <Button onClick={() => setView('form')}><Plus size={20} /> Add Staff</Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            {staff.filter(member => {
                                const query = searchQuery.toLowerCase();
                                return member.staffName.toLowerCase().includes(query) ||
                                    (member.phone && String(member.phone).toLowerCase().includes(query)) ||
                                    (member.address && String(member.address).toLowerCase().includes(query)) ||
                                    (member.notes && String(member.notes).toLowerCase().includes(query));
                            }).map(member => (
                                <Card key={member.id} className="relative group hover:border-brand-500/50 transition-colors flex flex-col justify-between">
                                    <div>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl font-bold text-slate-600 dark:text-slate-300">
                                                {member.staffName.charAt(0).toUpperCase()}
                                            </div>
                                            <Badge color={member.employmentType === 'Full-Time' ? 'green' : (member.employmentType === 'Part-Time' ? 'blue' : 'amber')}>
                                                {member.employmentType || 'N/A'}
                                            </Badge>
                                        </div>
                                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-1">{member.staffName}</h3>
                                        <p className="text-brand-600 dark:text-brand-400 text-sm font-medium mb-4">{member.position} • {member.duty}</p>

                                        <div className="space-y-2 text-sm text-slate-500 dark:text-slate-400">
                                            <div className="flex items-center gap-2"><Briefcase size={16} /> {member.experience} Year(s) Exp.</div>
                                            <div className="flex items-center gap-2"><MapPin size={16} /> {member.address || "No Address"}</div>
                                            <div className="flex items-center gap-2"><Phone size={16} /> {member.phone || "No Phone"}</div>
                                            {member.notes && <div className="flex items-center gap-2"><FileText size={16} /> {member.notes}</div>}
                                        </div>
                                    </div>

                                    <div className="flex justify-end gap-2 mt-6 pt-4 border-t border-slate-100 dark:border-slate-800">
                                        <Button variant="ghost" className="!p-2 text-sm" onClick={() => handleEdit(member)}><Edit size={16} /></Button>
                                        <Button variant="ghost" className="!p-2 text-sm text-red-500 hover:text-red-600 hover:bg-red-50" onClick={() => handleDelete(member.id)}><Trash2 size={16} /></Button>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };


        // 4. Nurse Roster Component
        const NurseRoster = ({ staff, roster, setRoster, customers }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);

            // Filter for active/relevant customers to show on roster
            const getCustomersForDate = (date) => {
                const targetDate = new Date(date);
                targetDate.setHours(0, 0, 0, 0);

                return customers.filter(customer => {
                    const serviceStartDate = new Date(customer.serviceDate);
                    serviceStartDate.setHours(0, 0, 0, 0);

                    const careDays = parseInt(customer.shiftTime) || 0;
                    if (careDays === 0) return false;

                    const serviceEndDate = new Date(serviceStartDate);
                    serviceEndDate.setDate(serviceStartDate.getDate() + careDays - 1); // -1 because inclusive
                    serviceEndDate.setHours(23, 59, 59, 999);

                    return targetDate >= serviceStartDate && targetDate <= serviceEndDate;
                });
            };

            // Temporary state for the modal form - for adding NEW shift
            const [newShift, setNewShift] = useState({
                nurseId: '',
                shiftType: 'D'
            });

            // Helper to get days in month
            const getDaysInMonth = (year, month) => {
                return new Date(year, month + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (year, month) => {
                return new Date(year, month, 1).getDay();
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);

            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            const handlePrevMonth = () => {
                setCurrentDate(new Date(year, month - 1, 1));
            };

            const handleNextMonth = () => {
                setCurrentDate(new Date(year, month + 1, 1));
            };

            const handleDayClick = (day) => {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                setSelectedDate(dateKey);
                setNewShift({ nurseId: '', shiftType: 'D' }); // Reset form
                setIsModalOpen(true);
            };

            const handleAddShift = () => {
                if (!selectedDate || !newShift.nurseId) return;

                const nurse = staff.find(s => s.id.toString() === newShift.nurseId);
                if (!nurse) return;

                const currentShifts = roster[selectedDate] || [];

                // Check for duplicate nurse on same day
                if (currentShifts.some(s => s.nurseId.toString() === newShift.nurseId)) {
                    alert('This nurse is already assigned to this day.');
                    return;
                }

                const updatedShifts = [...currentShifts, {
                    ...newShift,
                    nurseName: nurse.staffName
                }];

                setRoster(prev => ({
                    ...prev,
                    [selectedDate]: updatedShifts
                }));

                // Reset form but keep modal open to add more
                setNewShift({ ...newShift, nurseId: '' });
            };

            const handleRemoveShift = (nurseId) => {
                if (!selectedDate) return;
                const currentShifts = roster[selectedDate] || [];
                const updatedShifts = currentShifts.filter(s => s.nurseId.toString() !== nurseId.toString());

                if (updatedShifts.length === 0) {
                    const newRoster = { ...roster };
                    delete newRoster[selectedDate];
                    setRoster(newRoster);
                } else {
                    setRoster(prev => ({
                        ...prev,
                        [selectedDate]: updatedShifts
                    }));
                }
            };

            const currentDayShifts = selectedDate ? (roster[selectedDate] || []) : [];

            return (
                <div className="fade-in space-y-6">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white">Nurse Roster</h2>
                        <p className="text-slate-500 dark:text-slate-400">Manage daily shifts and assignments</p>
                    </div>

                    <Card>
                        {/* Calendar Header */}
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                <Calendar size={24} className="text-brand-600" />
                                {monthNames[month]} {year}
                            </h3>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={handlePrevMonth}><ChevronLeft size={20} /></Button>
                                <Button variant="secondary" onClick={() => setCurrentDate(new Date())}>Today</Button>
                                <Button variant="secondary" onClick={handleNextMonth}><ChevronRight size={20} /></Button>
                            </div>
                        </div>

                        {/* Calendar Grid */}
                        <div className="grid grid-cols-7 gap-2 mb-2 text-center">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                                <div key={day} className="font-semibold text-slate-500 text-sm uppercase tracking-wider py-2">
                                    {day}
                                </div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {/* Empty cells for previous month */}
                            {[...Array(firstDay)].map((_, i) => (
                                <div key={`empty-${i}`} className="h-32 bg-slate-50/50 dark:bg-slate-900/30 rounded-xl" />
                            ))}

                            {/* Days */}
                            {[...Array(daysInMonth)].map((_, i) => {
                                const day = i + 1;
                                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                const shifts = roster[dateKey] || [];
                                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                                // Check if date is in the past
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                const currentDate = new Date(year, month, day);
                                currentDate.setHours(0, 0, 0, 0);
                                const isPast = currentDate < today;

                                // Check if there are customers on this date
                                const customersOnDate = getCustomersForDate(new Date(year, month, day));
                                const hasCustomers = customersOnDate.length > 0;

                                // Can only click if not in past AND has customers
                                const canClick = !isPast && hasCustomers;

                                return (
                                    <div
                                        key={day}
                                        onClick={canClick ? () => handleDayClick(day) : undefined}
                                        className={`h-32 p-2 rounded-xl border transition-all relative group overflow-hidden
                                            ${!canClick ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
                                            ${isToday ? 'border-brand-500 bg-brand-50/30 dark:bg-brand-900/10' : 'border-slate-100 dark:border-slate-700 bg-white dark:bg-dark-800'}
                                            ${canClick && !isToday ? 'hover:border-brand-300 dark:hover:border-slate-600' : ''}
                                        `}
                                    >
                                        <div className={`text-sm font-medium w-6 h-6 flex items-center justify-center rounded-full mb-1
                                            ${isToday ? 'bg-brand-500 text-white' : 'text-slate-700 dark:text-slate-300'}
                                        `}>
                                            {day}
                                        </div>

                                        <div className="flex flex-col gap-1 max-h-[90px] overflow-y-auto no-scrollbar pb-1">
                                            {/* Customer Assignments Section */}
                                            {getCustomersForDate(new Date(year, month, day)).map((customer, idx) => (
                                                <div key={`cust-${idx}`} className="text-[10px] p-0.5 px-1.5 rounded bg-blue-50 text-blue-700 border border-blue-100 font-bold truncate flex items-center gap-1">
                                                    <Users size={10} className="shrink-0" />
                                                    {customer.customerName} ({customer.serviceCode})
                                                </div>
                                            ))}

                                            {/* Nurse Assignments Section */}
                                            <div className="border-t border-slate-50 dark:border-slate-800 my-0.5 pt-0.5"></div>
                                            {shifts.map((shift, idx) => (
                                                <div key={idx} className={`text-xs p-1 rounded-md font-medium truncate flex items-center gap-1
                                                    ${shift.shiftType === 'D' ? 'bg-amber-100 text-amber-800' :
                                                        shift.shiftType === 'N' ? 'bg-indigo-100 text-indigo-800' :
                                                            'bg-emerald-100 text-emerald-800'}
                                                `}>
                                                    <span className="font-bold text-[10px]">
                                                        {shift.shiftType === 'D' ? '☀' : shift.shiftType === 'N' ? '☾' : '24h'}
                                                    </span>
                                                    {shift.nurseName}
                                                </div>
                                            ))}
                                        </div>

                                        {/* Hover Add Button */}
                                        {shifts.length === 0 && (
                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-slate-50/50 dark:bg-slate-800/50 rounded-xl backdrop-blur-[1px]">
                                                <div className="bg-brand-100 text-brand-600 p-1.5 rounded-full"><Plus size={20} /></div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </Card>

                    {/* Shift Edit Modal Overlay */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 fade-in">
                            <div className="bg-white dark:bg-dark-900 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-slate-200 dark:border-slate-800 transform transition-all scale-100">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800 dark:text-white">
                                        Assign Shifts for {selectedDate}
                                    </h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                                        <X size={24} />
                                    </button>
                                </div>

                                {/* Current Assignments */}
                                <div className="mb-6">
                                    <h4 className="text-sm font-semibold text-slate-500 mb-3 uppercase tracking-wider">Current Assignments</h4>
                                    {currentDayShifts.length === 0 ? (
                                        <p className="text-slate-400 text-sm italic">No nurses assigned yet.</p>
                                    ) : (
                                        <div className="space-y-2">
                                            {currentDayShifts.map((shift, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-2 rounded-lg bg-slate-50 dark:bg-dark-800 border border-slate-100 dark:border-slate-800">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`w-6 h-6 flex items-center justify-center rounded text-xs font-bold
                                                            ${shift.shiftType === 'D' ? 'bg-amber-100 text-amber-700' :
                                                                shift.shiftType === 'N' ? 'bg-indigo-100 text-indigo-700' :
                                                                    'bg-emerald-100 text-emerald-700'}
                                                        `}>
                                                            {shift.shiftType}
                                                        </span>
                                                        <span className="font-medium text-slate-700 dark:text-slate-200">{shift.nurseName}</span>
                                                    </div>
                                                    <button
                                                        onClick={() => handleRemoveShift(shift.nurseId)}
                                                        className="text-slate-400 hover:text-red-500 transition-colors p-1"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <hr className="border-slate-100 dark:border-slate-800 my-4" />

                                {/* Add New Assignment */}
                                <div className="space-y-4">
                                    <h4 className="text-sm font-semibold text-slate-500 mb-2 uppercase tracking-wider">Add New Assignment</h4>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-500 mb-1.5">Select Nurse</label>
                                        <select
                                            className="w-full px-4 py-2.5 rounded-xl bg-slate-50 dark:bg-dark-800 border border-slate-200 dark:border-slate-700 outline-none focus:ring-2 focus:ring-brand-500/20"
                                            value={newShift.nurseId}
                                            onChange={e => setNewShift({ ...newShift, nurseId: e.target.value })}
                                        >
                                            <option value="">-- Choose Nurse --</option>
                                            {staff.filter(s => !currentDayShifts.some(assigned => assigned.nurseId.toString() === s.id.toString())).map(s => (
                                                <option key={s.id} value={s.id}>{s.staffName} ({s.duty})</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-slate-500 mb-1.5">Shift Type</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {['D', 'N', 'FD'].map((type) => (
                                                <button
                                                    key={type}
                                                    onClick={() => setNewShift({ ...newShift, shiftType: type })}
                                                    className={`py-2 px-3 rounded-lg border text-sm font-medium transition-all ${newShift.shiftType === type
                                                        ? 'bg-brand-50 border-brand-500 text-brand-700 ring-1 ring-brand-500'
                                                        : 'border-slate-200 hover:bg-slate-50 text-slate-600'
                                                        }`}
                                                >
                                                    {type === 'D' ? 'Morning (D)' : type === 'N' ? 'Night (N)' : 'Full Day'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <Button
                                        variant="primary"
                                        className="w-full justify-center mt-2"
                                        onClick={handleAddShift}
                                        disabled={!newShift.nurseId}
                                    >
                                        <Plus size={18} /> Add Assignment
                                    </Button>
                                </div>

                                <div className="mt-8 flex justify-end">
                                    <Button variant="secondary" onClick={() => setIsModalOpen(false)}>Done</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        // --- Layout & Main App ---

        const API_URL = "https://script.google.com/macros/s/AKfycbyAaG48aH_oGIwzTq3_F2WqCU1CaEsDB-6Ntyhmd_e8T0URWE0iOofw_jRX1fj-ZU9Cag/exec";

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [loadError, setLoadError] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);

            // Data State
            const [customers, setCustomers] = useState([]);
            const [staff, setStaff] = useState([]);
            const [roster, setRoster] = useState({}); // Date -> {nurseId, shiftType, nurseName}

            const postToSheet = async (body) => {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    },
                    body: JSON.stringify(body)
                });
                return res.json();
            };

            // Effects: Fetch Data from Google Sheets
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setIsLoading(true);
                        // Fetch both endpoints in parallel
                        const [custRes, staffRes] = await Promise.all([
                            fetch(API_URL + "?sheet=customers"),
                            fetch(API_URL + "?sheet=staffs")
                        ]);

                        if (!custRes.ok || !staffRes.ok) throw new Error("Failed to fetch data from API");

                        const custData = await custRes.json();
                        const staffData = await staffRes.json();

                        // เพิ่มเรื่องอายุโดยการคำนวนจาก birthYear
                        const processedCustomers = Array.isArray(custData) ? custData.map(c => {
                            // Calculate Age from BirthYear if Age is missing or we prefer BirthYear
                            if (c.birthYear && !c.age) {
                                return {
                                    ...c,
                                    age: new Date().getFullYear() - parseInt(c.birthYear)
                                };
                            }
                            // If age exists, keep it, or prefer birthYear calculation?
                            // User asked: "get data to show age... by subtracting current year with birthYear"
                            // So we should calculate it.
                            if (c.birthYear) {
                                return {
                                    ...c,
                                    age: new Date().getFullYear() - parseInt(c.birthYear)
                                };
                            }
                            return c;
                        }) : [];

                        setCustomers(processedCustomers);
                        setStaff(Array.isArray(staffData) ? staffData : []);
                    } catch (err) {
                        console.error("API Error:", err);
                        setLoadError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchData();
            }, []);

            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);



            const NavItem = ({ id, icon, label }) => (
                <button
                    onClick={() => setActiveTab(id)}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${activeTab === id
                        ? 'bg-brand-600 text-white shadow-lg shadow-brand-600/30'
                        : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:hover:text-white'
                        }`}
                >
                    <div className={activeTab === id ? 'text-white' : 'group-hover:scale-110 transition-transform'}>
                        {icon}
                    </div>
                    {isSidebarOpen && <span className="font-medium fade-in">{label}</span>}
                </button>
            );

            return (
                <div className="flex h-screen overflow-hidden bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
                    {/* Sidebar */}
                    <aside className={`flex-shrink-0 bg-white dark:bg-dark-950 border-r border-slate-200 dark:border-slate-800 flex flex-col transition-all duration-300 ease-in-out ${isSidebarOpen ? 'w-64' : 'w-0 overflow-hidden border-none'}`}>
                        <div className="p-6">
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-600 to-indigo-600 whitespace-nowrap flex items-center gap-2">
                                <Home size={28} className="text-brand-600" />
                                อุ่นใจ โฮมแคร์
                            </h1>
                            <p className="text-xs text-slate-400 mt-1 font-medium tracking-wide whitespace-nowrap">ระบบจัดการข้อมูลลูกค้าและพนักงาน</p>
                        </div>

                        <nav className="flex-1 px-4 space-y-2 overflow-y-auto overflow-x-hidden">
                            <NavItem id="dashboard" icon={<LayoutDashboard size={20} />} label="Dashboard" />
                            <NavItem id="customers" icon={<Users size={20} />} label="ระบบจัดการลูกค้า" />
                            <NavItem id="staff" icon={<Briefcase size={20} />} label="ระบบจัดการพนักงาน" />
                            <NavItem id="roster" icon={<Calendar size={20} />} label="ตารางงานพนักงาน" />
                        </nav>

                        <div className="p-4 border-t border-slate-100 dark:border-slate-800">
                            <button
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className="w-full flex items-center justify-between px-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-900 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
                            >
                                <span className="text-sm font-medium whitespace-nowrap">Theme</span>
                                {isDarkMode ? <Sun size={18} /> : <Moon size={18} />}
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-auto relative mainBG">
                        {/* Header Area */}
                        <header className="sticky top-0 z-20 bg-slate-50/80 dark:bg-slate-900/80 backdrop-blur-md px-8 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                    className="p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition-colors"
                                    title={isSidebarOpen ? "Hid Sidebar" : "Show Sidebar"}
                                >
                                    <Menu size={24} />
                                </button>
                                <h1 className="text-xl font-bold text-slate-800 dark:text-white capitalize">
                                    {activeTab}
                                </h1>
                            </div>

                            <div className="flex items-center gap-4">
                                <div className="text-sm text-slate-500 dark:text-slate-400">
                                    {new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                </div>
                                <div className="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 flex items-center justify-center font-bold">
                                    A
                                </div>
                            </div>
                        </header>

                        <div className="p-8 max-w-7xl mx-auto pb-20 mainBG">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center h-64 fade-in">
                                    <div className="w-12 h-12 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mb-4"></div>
                                    <p className="text-slate-500 font-medium">Loading data from Cloud...</p>
                                </div>
                            ) : loadError ? (
                                <div className="text-center p-10 bg-red-50 text-red-600 rounded-xl border border-red-200">
                                    <h3 className="font-bold">Connection Error</h3>
                                    <p>{loadError}</p>
                                    <Button onClick={() => window.location.reload()} className="mt-4 mx-auto" variant="secondary">Retry</Button>
                                </div>
                            ) : (
                                <>
                                    {activeTab === 'dashboard' && <Dashboard customers={customers} staff={staff} />}
                                    {activeTab === 'customers' && <CustomerManager customers={customers} setCustomers={setCustomers} postToSheet={postToSheet} />}
                                    {activeTab === 'staff' && <StaffManager staff={staff} setStaff={setStaff} postToSheet={postToSheet} />}
                                    {activeTab === 'roster' && <NurseRoster staff={staff} roster={roster} setRoster={setRoster} customers={customers} />}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>